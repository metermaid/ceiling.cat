<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>All Roads Lead Back to ITP</title>
  <meta name="description" content="For this week of Everything is Spatial, we used some geolocation data we generated over the last two weeks with the Moves application, and visualized the pat...">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/monokai_sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="For this week of Everything is Spatial, we used some geolocation data we generated over the last two weeks with the Moves application, and visualized the pat..." />
  <meta property="og:url" content="http://www.ceiling.cat" />
  <meta property="og:site_name" content="Ceiling.cat" />
  <meta property="og:title" content="All Roads Lead Back to ITP" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://www.ceiling.cat/assets/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  
  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="All Roads Lead Back to ITP">
  <meta name="twitter:description" content="For this week of Everything is Spatial, we used some geolocation data we generated over the last two weeks with the Moves application, and visualized the pat...">
  <meta name="twitter:image" content="http://www.ceiling.cat/assets/logo.png">
  <meta name="twitter:url" content="http://www.ceiling.cat">
  

  

  <!-- Site styles -->
  <link type="text/css" rel="stylesheet" href="/assets/main.css">
  
  <link rel="canonical" href="http://www.ceiling.cat/2017/02/12/allroads/">
  <link rel="alternate" type="application/rss+xml" title="Ceiling.cat" href="http://www.ceiling.cat/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      <img src="/assets/logo.png" alt="site.title" width="75" height="75">
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
          <li class="nav-link"><a href="/about/">About</a></li>
          
        
          
          <li class="nav-link"><a href="/posts/">Archives</a></li>
          
        
          
          <li class="nav-link"><a href="/fall-2016/">Fall 2016</a></li>
          
        
          
        
          
          <li class="nav-link"><a href="/spring-2017/">Spring 2017</a></li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">All Roads Lead Back to ITP</h1>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">February 12, 2017</div>
  <div class="post-categories">
  in 
    
    <a href="/category/spatial">Everything Is Spatial</a>
    
  
  </div>
</section>  

<article class="post-content">
  <p>For this week of Everything is Spatial, we used some geolocation data we generated over the last two weeks with the Moves application, and visualized the paths we took as well as the locations we visited.</p>

<p><img src="/assets/spatial_allroads/basic.png" width="" height="" alt="spatial_allroads/basic.png" /></p>

<p>This is the base map of my last two weeks– all roads lead back to ITP… I’m here a lot. I changed the paths to be a thinner line for travelling with public transit, and a thicker line for just walks.</p>

<p>We were then meant to enhance this data with one of the following:</p>

<ul>
  <li>Distance</li>
  <li>Animations</li>
  <li>Time</li>
  <li>Details of the places we visited (it’s currently just coordinates)</li>
  <li>A key or legend</li>
  <li>Frequency of visits</li>
</ul>

<p>I decided to go for the fourth option, and find details about the places I visited. Some of the locations I visited are already annotated, since I did so via the Moves app earlier, but I failed to do most of them. The rest I decided to use Google Maps’ geocoder to annotate, because I had done so before and was vaguely familiar with the process. I generated an API key, and wrote the following code to annotate the places with tooltips:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>onEachFeature(feature, layer) {
            if (feature.properties &amp;&amp;
                feature.properties.place &amp;&amp;
                feature.properties.place.name) {
                layer.bindTooltip(feature.properties.place.name, {permanent: true}).addTo(map);
            } else {
                var latlng = feature.properties.place.location;

                geocoder.geocode({'location': {lat: parseFloat(latlng.lat), lng: parseFloat(latlng.lon)}}, function(results, status) {
                if (status === 'OK') {
                  if (results[0]) {
                    layer.bindTooltip(results[0].formatted_address, {permanent: true}).addTo(map);
                  }
                }
                });
            }
        }
</code></pre>
</div>
<p>and this worked fairly well, as the following screenshot shows:</p>

<p><img src="/assets/spatial_allroads/annotations.png" width="" height="" alt="spatial_allroads/annotations.png" /></p>

<p>The problm with this code, however, is that Google Maps rate limits free accounts, and it fires the requests too rapidly. The majority of places go unlabeled. To solve this, we can slow down the labelling, but this is also not ideal: for a web application, you want to load as fast as possible.</p>

<p>Another problem with this code is that the API key is needed on the client side, leaving you exposed to potential abuse. Someone could use this code to ping Google with their own georequests, and waste your money or rates. To protect you from this, Google lets you restrict your key to usage by certain websites and IP addresses, which should help.</p>

<p>The practical solution for this would be to prepopulate the information, and do the Geomapping before on the server side. (Or else pay Google to no longer be rate limited.) This would solve both of these problems.</p>

<p>I’m very lazy though, so I decided to just restrict my key, and deal with the rate limit by just removing the addresses that failed to populate:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>        onEachFeature(feature, layer) {
            if (feature.properties &amp;&amp;
                feature.properties.place &amp;&amp;
                feature.properties.place.name) {
                layer.bindTooltip(feature.properties.place.name, {permanent: true}).addTo(map);
            } else {
                var latlng = feature.properties.place.location;

                geocoder.geocode({'location': {lat: parseFloat(latlng.lat), lng: parseFloat(latlng.lon)}}, function(results, status) {
                if (status === 'OK') {
                  if (results[0]) {
                    layer.bindTooltip(results[0].formatted_address, {permanent: true}).addTo(map);
                  } else {
                    placesLayer.removeLayer(layer);
                  }
                } else {
                    placesLayer.removeLayer(layer);
                }
                });
            }
        }
</code></pre>
</div>

<p>Done! Here’s the map below:</p>

<script src="https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.js"></script>

<link href="https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.css" rel="stylesheet" />

<script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCnH8dPy1Q156b4G5667i-LxOrhnIGC1hA"></script>

<div id="map" style="width: 100%; height: 500px;"></div>
<script>
// BaseMap
var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png');
var map = L.map('map').setView([40.7246342, -73.9427715], 13);
map.addLayer(layer);


var walkingLayer = L.geoJson(null, {
filter: function(feature) {
    // my custom filter function
    return feature.properties.activities.map(function(x){ return x.activity }) == "walking";
},
style: function(feature) {
    // my custom filter function
    return {
        color: "#9e9",
        weight: 5
    };

}
});
var transportLayer = L.geoJson(null, {
filter: function(feature) {
    // my custom filter function
    return feature.properties.activities.map(function(x){ return x.activity }).includes("transport");
},
style: function(feature) {
    // my custom filter function
    return {
        color: "#4a4",
        weight: 1,
        opacity: 0.5
    };

}
});
var dataLayer = omnivore.geojson("/assets/spatial_allroads/activities.json", null, walkingLayer).addTo(map);
var dataLayer = omnivore.geojson("/assets/spatial_allroads/activities.json", null, transportLayer).addTo(map);
var geocoder = new google.maps.Geocoder;

var placesLayer =  L.geoJson(null, {
    // filter: function(feature) {
    //     return feature.properties.place.name;
    // },
    pointToLayer: function (feature, latlng) {
        return new L.CircleMarker(latlng, {
            radius:7,
            color: "white",
            fillOpacity: 0.5
        })},
    onEachFeature(feature, layer) {
        if (feature.properties &&
            feature.properties.place &&
            feature.properties.place.name) {
            layer.bindTooltip(feature.properties.place.name, {permanent: true}).addTo(map);
        } else {
            var latlng = feature.properties.place.location;

            geocoder.geocode({'location': {lat: parseFloat(latlng.lat), lng: parseFloat(latlng.lon)}}, function(results, status) {
            if (status === 'OK') {
              if (results[0]) {
                layer.bindTooltip(results[0].formatted_address, {permanent: true}).addTo(map);
              } else {
                placesLayer.removeLayer(layer);
              }
            } else {
                placesLayer.removeLayer(layer);
            }
            });
        }
    }
});

var pdataLayer = omnivore.geojson("/assets/spatial_allroads/places.json", null, placesLayer).addTo(map);

</script>


</article>



<section class="tags">
  <strong>Tags:</strong> <a href="/tag/everything-is-spatial">Everything Is Spatial</a>, <a href="/tag/spatial">Spatial</a>
</section>



<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
      <a href="//twitter.com/share?text=All+Roads+Lead+Back+to+ITP&url=http://www.ceiling.cat/2017/02/12/allroads/&via=rtchng"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
        <i class="fa fa-twitter-square fa-lg"></i>
      </a>
    
    
    
    
    
    
  
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
  
</section>




<section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'ceilingcat';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">Ceiling.cat</h3>

    <div class="site-navigation">
      
      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">About</a>
        
        
        
          <li class="nav-link"><a href="/posts/">Archives</a>
        
        
        
          <li class="nav-link"><a href="/fall-2016/">Fall 2016</a>
        
        
        
        
        
          <li class="nav-link"><a href="/spring-2017/">Spring 2017</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
            <i class="fa fa-envelope-o"></i>
            <span class="username">rita@ritacheng.com</span>
        </li>

        
          
          <li>
            <a href="https://twitter.com/rtchng" title="Follow me on Twitter">
              <i class="fa fa-twitter"></i>
              <span class="username">rtchng</span>
            </a>
          </li>
          
        
          
          <li>
            <a href="https://github.com/metermaid" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">metermaid</span>
            </a>
          </li>
          
        
          
          <li>
            <a href="http://www.instagram.com/risky" title="Follow me on Instagram">
              <i class="fa fa-instagram"></i>
              <span class="username">risky</span>
            </a>
          </li>
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text"></p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>
<script>

$(document).ready(function() {

  // Syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });


});

</script>




  </body>

</html>
